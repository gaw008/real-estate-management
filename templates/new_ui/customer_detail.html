{% extends "new_ui/base.html" %}

{% block title %}å®¢æˆ·è¯¦æƒ… - {{ customer.name }}{% endblock %}

{% block page_title %}å®¢æˆ·è¯¦æƒ… - {{ customer.name }}{% endblock %}

{% block content %}
<!-- æ“ä½œæ  -->
<div class="action-bar" style="margin-bottom: 20px;">
    <a href="{{ url_for('customer_tracking') }}" class="btn btn-secondary">
        â† è¿”å›å®¢æˆ·åˆ—è¡¨
    </a>
    <a href="{{ url_for('edit_customer_tracking', customer_id=customer.id) }}" class="btn btn-primary">
        âœï¸ ç¼–è¾‘å®¢æˆ·
    </a>
</div>

<!-- å®¢æˆ·åŸºæœ¬ä¿¡æ¯ -->
<div class="table-container">
    <h3>åŸºæœ¬ä¿¡æ¯</h3>
    <table class="table">
        <tr>
            <td><strong>å®¢æˆ·å§“å</strong></td>
            <td>{{ customer.name }}</td>
            <td><strong>è”ç³»ç”µè¯</strong></td>
            <td>{{ customer.phone or 'æœªæä¾›' }}</td>
        </tr>
        <tr>
            <td><strong>é‚®ç®±åœ°å€</strong></td>
            <td>{{ customer.email or 'æœªæä¾›' }}</td>
            <td><strong>è·Ÿè¸ªçŠ¶æ€</strong></td>
            <td>
                <span class="status-badge status-{{ 
                    'completed' if customer.tracking_status in ['ç­¾çº¦å®Œæˆ'] 
                    else 'active' if customer.tracking_status in ['è·Ÿè¿›æœåŠ¡', 'ä»·æ ¼è°ˆåˆ¤', 'åˆåŒå‡†å¤‡'] 
                    else 'pending' if customer.tracking_status in ['çœ‹æˆ¿å®‰æ’', 'åˆå§‹æ¥è§¦'] 
                    else 'default' 
                }}">
                    {{ customer.tracking_status }}
                </span>
            </td>
        </tr>
        <tr>
            <td><strong>åˆ›å»ºæ—¶é—´</strong></td>
            <td>{{ customer.created_at.strftime('%Y-%m-%d %H:%M') if customer.created_at else '-' }}</td>
            <td><strong>æœ€åæ›´æ–°</strong></td>
            <td>{{ customer.updated_at.strftime('%Y-%m-%d %H:%M') if customer.updated_at else '-' }}</td>
        </tr>
        <tr>
            <td><strong>ç­¾çº¦æ—¶é—´</strong></td>
            <td>{{ customer.contract_date.strftime('%Yå¹´%mæœˆ%dæ—¥') if customer.contract_date else 'æœªç­¾çº¦' }}</td>
            <td><strong>è§£çº¦æ—¶é—´</strong></td>
            <td>{{ customer.termination_date.strftime('%Yå¹´%mæœˆ%dæ—¥') if customer.termination_date else 'æœªè§£çº¦' }}</td>
        </tr>
    </table>

    <!-- æˆ¿äº§ä¿¡æ¯ -->
    <h3 style="margin-top: 20px;">æˆ¿äº§ä¿¡æ¯</h3>
    <table class="table">
        <tr>
            <td><strong>æˆ¿äº§åœ°å€</strong></td>
            <td colspan="3">
                {% if customer.property_address %}
                    {{ customer.property_address|nl2br }}
                {% else %}
                    æœªæä¾›
                {% endif %}
            </td>
        </tr>
        <tr>
            <td><strong>ç§Ÿèµç±»åˆ«</strong></td>
            <td colspan="3">
                {% if customer.rental_types %}
                    {% for type in customer.rental_types %}
                    <span class="status-badge status-active" style="margin-right: 5px;">{{ type }}</span>
                    {% endfor %}
                {% else %}
                    æœªé€‰æ‹©
                {% endif %}
            </td>
        </tr>
    </table>

    <!-- å¤‡æ³¨ä¿¡æ¯ -->
    {% if customer.notes %}
    <h3 style="margin-top: 20px;">å¤‡æ³¨</h3>
    <div class="notes-section">
        {{ customer.notes|nl2br }}
    </div>
    {% endif %}

    <!-- è·Ÿè¸ªè®°å½• -->
    <h3 style="margin-top: 20px;">è·Ÿè¸ªè®°å½•</h3>
    <div class="action-bar" style="margin-bottom: 15px;">
        <button class="btn btn-primary" onclick="toggleAddRecordForm()">
            â• æ·»åŠ è®°å½•
        </button>
    </div>

    <!-- æ·»åŠ è®°å½•è¡¨å• -->
    <div id="addRecordForm" class="form-section" style="display: none;">
        <div class="form-card">
            <div class="form-header">
                <h4>æ·»åŠ è·Ÿè¸ªè®°å½•</h4>
                <button type="button" class="close-btn" onclick="toggleAddRecordForm()">Ã—</button>
            </div>
            <form method="POST" action="{{ url_for('add_tracking_record', customer_id=customer.id) }}">
                <div class="form-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="record_date">è®°å½•æ—¥æœŸ *</label>
                            <input type="date" class="form-input" id="record_date" name="record_date" 
                                   value="{{ today }}" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="content">è®°å½•å†…å®¹ *</label>
                            <textarea class="form-input" id="content" name="content" rows="6" 
                                      placeholder="è¯·è¯¦ç»†è®°å½•ä¸å®¢æˆ·çš„æ²Ÿé€šæƒ…å†µã€è¿›å±•ã€ä¸‹ä¸€æ­¥è®¡åˆ’ç­‰..." required></textarea>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="toggleAddRecordForm()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜è®°å½•</button>
                </div>
            </form>
        </div>
    </div>

    <!-- è·Ÿè¸ªè®°å½•åˆ—è¡¨ -->
    {% if tracking_records %}
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>è®°å½•å†…å®¹</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for record in tracking_records %}
                <tr>
                    <td>{{ record.record_date.strftime('%Yå¹´%mæœˆ%dæ—¥') }}</td>
                    <td>{{ record.content|nl2br }}</td>
                    <td>{{ record.created_at.strftime('%H:%M') if record.created_at else '' }}</td>
                    <td class="action-buttons">
                        <button type="button" class="btn btn-sm btn-primary" 
                                data-record-id="{{ record.id }}"
                                data-record-date="{{ record.record_date.strftime('%Y-%m-%d') }}"
                                data-record-content="{{ record.content|replace('\n', '\\n')|replace('"', '\\"')|replace("'", "\\'") }}"
                                onclick="editRecordFromData(this)">
                            âœï¸ ç¼–è¾‘
                        </button>
                        <button type="button" class="btn btn-sm btn-danger" 
                                onclick="deleteRecord({{ record.id }}, '{{ record.record_date.strftime('%Yå¹´%mæœˆ%dæ—¥') }}')">
                            ğŸ—‘ï¸ åˆ é™¤
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <p>æš‚æ— è·Ÿè¸ªè®°å½•</p>
        <p>ç‚¹å‡»"æ·»åŠ è®°å½•"å¼€å§‹è®°å½•ä¸å®¢æˆ·çš„æ²Ÿé€šæƒ…å†µ</p>
    </div>
    {% endif %}
</div>

<!-- ç¼–è¾‘è®°å½•è¡¨å• -->
<div id="editRecordForm" class="form-section" style="display: none;">
    <div class="form-card">
        <div class="form-header">
            <h4>ç¼–è¾‘è·Ÿè¸ªè®°å½•</h4>
            <button type="button" class="close-btn" onclick="toggleEditRecordForm()">Ã—</button>
        </div>
        <form method="POST" action="{{ url_for('update_tracking_record') }}">
            <input type="hidden" id="edit_record_id" name="record_id">
            <div class="form-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_record_date">è®°å½•æ—¥æœŸ *</label>
                        <input type="date" class="form-input" id="edit_record_date" name="record_date" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_content">è®°å½•å†…å®¹ *</label>
                        <textarea class="form-input" id="edit_content" name="content" rows="6" required></textarea>
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="toggleEditRecordForm()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">æ›´æ–°è®°å½•</button>
            </div>
        </form>
    </div>
</div>

<!-- åˆ é™¤ç¡®è®¤å¯¹è¯æ¡† -->
<div id="deleteDialog" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h4>ç¡®è®¤åˆ é™¤</h4>
            <button type="button" class="close-btn" onclick="closeDeleteDialog()">Ã—</button>
        </div>
        <div class="modal-body">
            <p>ç¡®å®šè¦åˆ é™¤è¿™æ¡è·Ÿè¸ªè®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
            <p><strong>è®°å½•æ—¥æœŸï¼š</strong><span id="deleteRecordDate"></span></p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteDialog()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteRecord()">ç¡®è®¤åˆ é™¤</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentRecordId = null;

function toggleAddRecordForm() {
    const form = document.getElementById('addRecordForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function toggleEditRecordForm() {
    const form = document.getElementById('editRecordForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function editRecordFromData(button) {
    const recordId = button.dataset.recordId;
    const recordDate = button.dataset.recordDate;
    const recordContent = button.dataset.recordContent;

    document.getElementById('edit_record_id').value = recordId;
    document.getElementById('edit_record_date').value = recordDate;
    document.getElementById('edit_content').value = recordContent;
    toggleEditRecordForm();
}

function deleteRecord(recordId, recordDate) {
    currentRecordId = recordId;
    document.getElementById('deleteRecordDate').textContent = recordDate;
    document.getElementById('deleteDialog').style.display = 'block';
}

function closeDeleteDialog() {
    document.getElementById('deleteDialog').style.display = 'none';
    currentRecordId = null;
}

function confirmDeleteRecord() {
    if (!currentRecordId) return;
    
    fetch('{{ url_for("delete_tracking_record") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `record_id=${currentRecordId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('è®°å½•åˆ é™¤æˆåŠŸ');
            location.reload();
        } else {
            alert('åˆ é™¤å¤±è´¥ï¼š' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    });
    closeDeleteDialog();
}
</script>
{% endblock %} 